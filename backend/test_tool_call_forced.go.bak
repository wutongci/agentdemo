package main

import (
	"context"
	"fmt"
	"log"
	"os"
	"time"

	"github.com/coso/agentdemo/backend/agent"
	"github.com/joho/godotenv"
	"github.com/wordflowlab/agentsdk/pkg/types"
)

func main() {
	godotenv.Load("../.env")

	log.Println("=== Testing FORCED Tool Calls ===")

	manager, err := agent.NewManager()
	if err != nil {
		log.Fatalf("Failed to create manager: %v", err)
	}

	// 创建非常强制性的模板
	// 支持 GLM 4.6 或 Anthropic
	model := os.Getenv("MODEL")
	if model == "" {
		model = "glm-4" // 默认使用 GLM 4.6
	}

	testTemplate := &types.AgentTemplateDefinition{
		ID:    "test-forced",
		Model: model,
		SystemPrompt: `You are a file writing assistant. Your ONLY job is to call the fs_write tool when asked to write files.

CRITICAL RULES:
1. When the user asks you to write a file, you MUST call fs_write immediately
2. Do NOT write text responses explaining how you will write the file
3. Do NOT describe the tool usage
4. Call fs_write directly with the path and content parameters
5. Your response MUST contain a tool_use block, not text

The fs_write tool requires:
- path: string (file path)
- content: string (file content)

Example tool call (you must do this, not describe it):
{
  "type": "tool_use",
  "name": "fs_write",
  "input": {
    "path": "test.txt",
    "content": "Hello World"
  }
}`,
		Tools: []interface{}{"fs_write"},
	}

	templateRegistry := manager.GetDependencies().TemplateRegistry
	templateRegistry.Register(testTemplate)

	ctx := context.Background()
	ag, err := manager.CreateTemporaryAgent(ctx, "test-forced")
	if err != nil {
		log.Fatalf("Failed to create agent: %v", err)
	}

	log.Printf("Created agent: %s", ag.ID())

	// 订阅事件
	eventCh := ag.Subscribe([]types.AgentChannel{types.ChannelProgress}, nil)
	toolUseEvents := []string{}

	go func() {
		for envelope := range eventCh {
			switch envelope.Event.(type) {
			case *types.ProgressToolStartEvent:
				toolUseEvents = append(toolUseEvents, "tool_start")
				log.Printf("✅✅✅ TOOL START EVENT DETECTED!")
			case *types.ProgressToolEndEvent:
				toolUseEvents = append(toolUseEvents, "tool_end")
				log.Printf("✅✅✅ TOOL END EVENT DETECTED!")
			default:
				eventType := fmt.Sprintf("%T", envelope.Event)
				if len(eventType) > 50 {
					eventType = eventType[:50] + "..."
				}
				log.Printf("Event: %s", eventType)
			}
		}
	}()

	// 测试：非常明确的指令
	log.Println("\n=== Test: Very explicit instruction ===")
	result, err := ag.Chat(ctx, "Call fs_write tool now with path='test.txt' and content='Hello World'. Do not write any text, only call the tool.")
	if err != nil {
		log.Fatalf("Chat failed: %v", err)
	}

	log.Printf("Status: %s", result.Status)
	log.Printf("Text response: %s", result.Text)

	time.Sleep(3 * time.Second)

	log.Printf("\n=== Summary ===")
	log.Printf("Tool events: %d", len(toolUseEvents))
	if len(toolUseEvents) == 0 {
		log.Println("❌❌❌ STILL NO TOOL CALLS!")
		log.Println("\nThis suggests the issue is with:")
		log.Println("  1. Anthropic API not recognizing tools")
		log.Println("  2. yunwu.ai proxy not passing tools correctly")
		log.Println("  3. Tool schema format incompatibility")
	} else {
		log.Println("✅✅✅ TOOL CALLS DETECTED!")
	}
}
